<!DOCTYPE html>
<html lang="ja"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><title>Google Cloud Endpoints for gRPCの認証まわり - nownab.log</title><link rel="alternate" type="application/rss+xml" href="https://blog.nownabe.com/feed.xml" title="nownab.log">

  <link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico">

  <link rel="stylesheet" href="/css/ress.min.css">
  <link rel="stylesheet" href="/css/chroma.css"><link rel="stylesheet" href="/css/main.5e4d516051eaf80a3c96a5c8f160303915afcc3032634b1464e11720b1cf6bafc8000f3702ccefb89370bcd03fc09d21504e28907f8d52906eb783ead567c35b.css" integrity="sha512-Xk1RYFHq&#43;Ao8lqXI8WAwORWvzDAyY0sUZOEXILHPa6/IAA83AszvuJNwvNA/wJ0hUE4okH&#43;NUpBut4Pq1WfDWw==">

  <meta name="author" content="nownabe">
  <meta name="description" content="the nownabe&#39;s life log">

  <meta property="og:site_name" content="nownab.log">
  <meta property="og:type" content="article">

  <meta property="twitter:card" content="summary">
  <meta property="twitter:site" content="@nownabe">
  <meta property="twitter:creator" content="@nownabe">

  <meta property="fb:app_id" content="1775541316016693"><meta property="og:url" content="https://blog.nownabe.com/2018/02/05/1248.html/">
  <meta property="og:title" content="Google Cloud Endpoints for gRPCの認証まわり - nownab.log">
  <meta property="og:description" content="はじめに Cloud Endpoints for gRPCの認証まわりでちょっと引っかかったので整理しました。 GCPのドキュメントは大元の英語版であっても間違ってる箇所が多いの">
  <meta property="og:image" content="https://blog.nownabe.com/img/nownabe.png">
  <meta property="twitter:title" content="Google Cloud Endpoints for gRPCの認証まわり - nownab.log">
  <meta property="twitter:description" content="はじめに Cloud Endpoints for gRPCの認証まわりでちょっと引っかかったので整理しました。 GCPのドキュメントは大元の英語版であっても間違ってる箇所が多いの">
  <meta property="twitter:image" content="https://blog.nownabe.com/img/nownabe.png">
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-37580164-4', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</head>
<body>
  <div id="site-container"><div id="header-container">
  <header class="container">
    <h1>
      <a href="/">
        <img src="/img/nownabe.svg" alt="nownabe logo">
        nownab.log
      </a>
    </h1>
    <p>the nownabe&#39;s life log</p>
  </header>
</div>
<div id="content-container">
      <div class="container" role="main">
<article>
  <div class="title">
    <h2><a href="https://blog.nownabe.com/2018/02/05/1248.html/">Google Cloud Endpoints for gRPCの認証まわり</a></h2>
    <span class="date">Posted on Feb 5, 2018</span>
  </div>
  <div class="body">
    

<h1 id="はじめに">はじめに</h1>

<p>Cloud Endpoints for gRPCの認証まわりでちょっと引っかかったので整理しました。
GCPのドキュメントは大元の英語版であっても間違ってる箇所が多いので注意が必要です。</p>

<p>言語はGolangです。</p>

<h1 id="cloud-endpoints">Cloud Endpoints</h1>

<p><a href="https://cloud.google.com/endpoints/?hl=ja">Cloud Endpoints</a>はAPIを管理するためのサービスです。いまいちわかりにくいですが、こんなことをやってくれます。</p>

<ul>
<li>gRPC APIをREST APIに変換して提供</li>
<li>APIのモニタリング</li>
<li>Auth0やFirebaseでの認証</li>
</ul>

<p>Cloud Endpointsは大きく3つの形式で利用できます。</p>

<ul>
<li><a href="https://cloud.google.com/endpoints/docs/openapi/?hl=ja">OpenAPI (JSON/REST API)</a>

<ul>
<li>一般的なREST APIをCloud Endpointsで管理する感じ</li>
<li>旧Swagger</li>
</ul></li>
<li><a href="https://cloud.google.com/endpoints/docs/frameworks/about-cloud-endpoints-frameworks?hl=ja">Endpoints Framework</a>

<ul>
<li>アプリケーションに組み込んで使うタイプ</li>
<li>App Engine Standard、Java or Python</li>
</ul></li>
<li><a href="https://cloud.google.com/endpoints/docs/grpc/about-grpc?hl=ja">gRPC</a></li>
</ul>

<h1 id="extensible-service-proxy">Extensible Service Proxy</h1>

<p>for gRPCではリクエストは<a href="https://cloud.google.com/endpoints/docs/frameworks-extensible-service-proxy?hl=ja">Extensible Service Proxy</a>(以下ESP)を経由することになります。ESPはNginxベースのリバースプロキシでCloud Endpointsの機能を提供します。</p>

<p>このESPをサイドカーコンテナとしてアプリケーションと一緒にデプロイすることでCloud Endpointsの機能を利用できます。</p>

<h1 id="認証">認証</h1>

<p>Cloud Endpointsの認証には大きくわけて2種類あります。</p>

<ul>
<li>APIキー

<ul>
<li>呼び出し元を識別する</li>
</ul></li>
<li>認証スキーム (Firebase、Auth0など)

<ul>
<li>エンドユーザを識別する</li>
</ul></li>
</ul>

<h2 id="apiキー">APIキー</h2>

<p><a href="https://cloud.google.com/endpoints/docs/restricting-api-access-with-api-keys-grpc?hl=ja">API キーで API アクセスを制限する（gRPC）  |  Cloud Endpoints  |  Google Cloud Platform</a></p>

<p>APIキーの認証を有効化するには<a href="https://cloud.google.com/endpoints/docs/grpc/grpc-service-config?hl=ja">サービス設定</a>の<code>usage.rules</code>で<code>allow_unregistered_calls</code>を<code>false</code>にします。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">usage<span class="p">:</span><span class="w">
</span><span class="w">  </span>rules<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">      </span>allow_unregistered_calls<span class="p">:</span><span class="w"> </span><span class="kc">false</span></code></pre></div>
<p>クライアント側はmetadataの<code>x-api-key</code>にAPIキーをセットしてリクエストします。また、例えばAPIキーの制限としてリファラを設定している場合は、metadataの<code>referer</code>にリファラをセットする必要があります。</p>

<h2 id="認証スキーム">認証スキーム</h2>

<p><a href="https://cloud.google.com/endpoints/docs/grpc/authenticating-users-grpc?hl=ja">ユーザーの認証  |  gRPC を使用する Cloud Endpoints  |  Google Cloud Platform</a></p>

<p>認証スキームではより細い認証を行うことができます。Firebaseやサービスアカウント、Auth0などで認証することができます。有効化するにはサービス設定の<code>authentication</code>を設定します。</p>

<p>クライアント側ではmetadataの<code>authorization</code>に<code>Baarer + token</code>をセットします。</p>

<h1 id="やってみる">やってみる</h1>

<p>実際に実装して認証結果をみていきます。細かい部分はかなり適当なのでそのままプロダクションでは使わないでください。</p>

<p>gRPCのメソッドはEcho1〜4までの4つを用意して、次のように認証を設定します。</p>

<table>
<thead>
<tr>
<th>メソッド</th>
<th>APIキー認証</th>
<th>認証スキーム認証</th>
</tr>
</thead>

<tbody>
<tr>
<td>Echo1</td>
<td>なし</td>
<td>なし</td>
</tr>

<tr>
<td>Echo2</td>
<td>なし</td>
<td>あり</td>
</tr>

<tr>
<td>Echo3</td>
<td>あり</td>
<td>なし</td>
</tr>

<tr>
<td>Echo4</td>
<td>あり</td>
<td>あり</td>
</tr>
</tbody>
</table>

<p>認証スキームにはサービスアカウントを利用します。</p>

<p>ここではGCPのプロジェクトとして<code>cloud-endpoints-grpc-auth</code>を使っています。適宜書き換えてください。</p>

<p>完成コードは<a href="https://github.com/nownabe/examples/tree/master/cloud-endpoints-grpc-authentication">こちら</a>にあります。</p>

<h2 id="サービスの定義-実装">サービスの定義・実装</h2>

<p>まず、gRPCのサービスを定義してGoのコードとデスクリプタファイルを生成します。</p>
<div class="highlight"><pre class="chroma"><code class="language-proto:echo.proto" data-lang="proto:echo.proto"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kn">package</span> <span class="nn">echo</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="k">option</span> <span class="n">go_package</span> <span class="o">=</span> <span class="s">&#34;main&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">service</span> <span class="n">EchoService</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">Echo1</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">Echo2</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">Echo3</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span>  <span class="k">rpc</span> <span class="n">Echo4</span> <span class="p">(</span><span class="n">Request</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">Response</span><span class="p">)</span> <span class="p">{}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Request</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">Response</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">protoc <span class="se">\
</span><span class="se"></span>  -I<span class="o">=</span>. <span class="se">\
</span><span class="se"></span>  --include_source_info <span class="se">\
</span><span class="se"></span>  --descriptor_set_out<span class="o">=</span>echo.pb <span class="se">\
</span><span class="se"></span>  --go_out<span class="o">=</span><span class="nv">plugins</span><span class="o">=</span>grpc:. <span class="se">\
</span><span class="se"></span>  echo.proto</code></pre></div>
<p>次に、サーバとクライアントを実装します。まだ認証部分は実装しません。それぞれのディレクトリを作成します。ここではめんどくさいのでpbファイルはコピーします。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">mkdir server client
cp echo.pb.go server
cp echo.pb.go client</code></pre></div>
<p>サーバの実装です。</p>
<div class="highlight"><pre class="chroma"><code class="language-go:server/main.go" data-lang="go:server/main.go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net&#34;</span>

	<span class="s">&#34;golang.org/x/net/context&#34;</span>
	<span class="s">&#34;google.golang.org/grpc&#34;</span>
	<span class="s">&#34;google.golang.org/grpc/metadata&#34;</span>
	<span class="s">&#34;google.golang.org/grpc/reflection&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">port</span> <span class="p">=</span> <span class="s">&#34;:50051&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">echo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">md</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">FromIncomingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;, Metadata:&#34;</span><span class="p">,</span> <span class="nx">md</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Response</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Message</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="nf">Echo1</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Echo1 Received: &#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
	<span class="k">return</span> <span class="nf">echo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="nf">Echo2</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Echo2 Received: &#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
	<span class="k">return</span> <span class="nf">echo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="nf">Echo3</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Echo3 Received: &#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
	<span class="k">return</span> <span class="nf">echo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="nf">Echo4</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Echo4 Received: &#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
	<span class="k">return</span> <span class="nf">echo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
	<span class="nf">RegisterEchoServiceServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">server</span><span class="p">{})</span>
	<span class="nx">reflection</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>

	<span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>metadataの<code>x-endpoint-api-userinfo</code>には認証したユーザの情報が入ります。</p>

<p>起動してみましょう。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> server
go get .
go run *.go</code></pre></div>
<p>クライアントの実装です。</p>
<div class="highlight"><pre class="chroma"><code class="language-go:client/main.go" data-lang="go:client/main.go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="s">&#34;golang.org/x/net/context&#34;</span>
	<span class="s">&#34;google.golang.org/grpc&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">msg</span> <span class="kt">string</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;127.0.0.1:50051&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">msg</span><span class="p">,</span> <span class="s">&#34;msg&#34;</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">,</span> <span class="s">&#34;message&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">c</span> <span class="o">:=</span> <span class="nf">NewEchoServiceClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>

	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="nx">msg</span><span class="p">}</span>

	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Echo1</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo1: succeeded:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo1: failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Echo2</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo2: succeeded:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo2: failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Echo3</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo3: succeeded:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo3: failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Echo4</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo4: succeeded:&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo4: failed:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>サーバが起動していることを確認して、クライアントを実行してみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> client
go run *.go</code></pre></div>
<p>次のような出力が得られます。</p>

<pre><code>Echo1: succeeded: message:&quot;Hello&quot;
Echo2: succeeded: message:&quot;Hello&quot;
Echo3: succeeded: message:&quot;Hello&quot;
Echo4: succeeded: message:&quot;Hello&quot;
</code></pre>

<p>これでgRPCサービスの定義と実装がおわりました。</p>

<h2 id="cloud-endpointsのデプロイ">Cloud Endpointsのデプロイ</h2>

<p>Cloud Endpointsをデプロイする前に、認証に必要なサービスアカウントを作成しておきます。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">gcloud iam service-accounts create client1 --display-name<span class="o">=</span>client1
gcloud iam service-accounts add-iam-policy-binding <span class="se">\
</span><span class="se"></span>  client1@cloud-endpoints-grpc-auth.iam.gserviceaccount.com <span class="se">\
</span><span class="se"></span>  --member serviceAccount:client1@cloud-endpoints-grpc-auth.iam.gserviceaccount.com <span class="se">\
</span><span class="se"></span>  --role roles/iam.serviceAccountUser</code></pre></div>
<p>前述の表を満たすようにサービス設定をYAMLで書きます。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml:api_config.yaml" data-lang="yaml:api_config.yaml">type<span class="p">:</span><span class="w"> </span>google.api.Service<span class="w">
</span><span class="w"></span>config_version<span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">
</span><span class="w"></span>name<span class="p">:</span><span class="w"> </span>echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog<span class="w">
</span><span class="w">
</span><span class="w"></span>title<span class="p">:</span><span class="w"> </span>Echo<span class="w"> </span>API<span class="w">
</span><span class="w"></span>apis<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>echo.EchoService<span class="w">
</span><span class="w">
</span><span class="w"></span>usage<span class="p">:</span><span class="w">
</span><span class="w">  </span>rules<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo1&#34;</span><span class="w">
</span><span class="w">      </span>allow_unregistered_calls<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo2&#34;</span><span class="w">
</span><span class="w">      </span>allow_unregistered_calls<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo3&#34;</span><span class="w">
</span><span class="w">      </span>allow_unregistered_calls<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo4&#34;</span><span class="w">
</span><span class="w">      </span>allow_unregistered_calls<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span>authentication<span class="p">:</span><span class="w">
</span><span class="w">  </span>providers<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>id<span class="p">:</span><span class="w"> </span>client1<span class="w">
</span><span class="w">      </span>issuer<span class="p">:</span><span class="w"> </span>client1@cloud-endpoints-grpc-auth.iam.serviceaccount.com<span class="w">
</span><span class="w">      </span>jwks_uri<span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//www.googleapis.com/robot/v1/metadata/x509/client1@cloud-endpoints-grpc-auth.iam.gserviceaccount.com<span class="w">
</span><span class="w">  </span>rules<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo2&#34;</span><span class="w">
</span><span class="w">      </span>requirements<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>provider_id<span class="p">:</span><span class="w"> </span>client1<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>selector<span class="p">:</span><span class="w"> </span><span class="s2">&#34;echo.EchoService.Echo4&#34;</span><span class="w">
</span><span class="w">      </span>requirements<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>provider_id<span class="p">:</span><span class="w"> </span>client1</code></pre></div>
<p>Cloud Endpointsをデプロイします。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">gcloud endpoints services deploy api_config.yaml echo.pb</code></pre></div>
<p>成功すると次のようなメッセージが表示されます。</p>

<pre><code>Service Configuration [2018-02-05r0] uploaded for service [echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog]

To manage your API, go to: https://console.cloud.google.com/endpoints/api/echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog/overview?project=cloud-endpoints-grpc-auth
</code></pre>

<p>この<code>2018-02-05r0</code>と<code>echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog</code>は後で必要になります。また、最後のURLにアクセスするとAPIのダッシュボードが表示され、モニタリング結果を確認できます。</p>

<h2 id="apiのデプロイ">APIのデプロイ</h2>

<p>実装したAPI(サービス)をデプロイします。今回はGKEにデプロイします。また、Cloud Endpointsを有効にするため、サイドカーコンテナとしてESPを使います。</p>

<p>まずはサーバのDockerfileを定義します。</p>
<div class="highlight"><pre class="chroma"><code class="language-dockerfile:server/Dockerfile" data-lang="dockerfile:server/Dockerfile"><span class="k">FROM</span><span class="s"> golang:1.9</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go/src/app</span><span class="err">
</span><span class="err"></span><span class="k">ADD</span><span class="s"> . .</span><span class="err">
</span><span class="err"></span><span class="k">RUN</span> go get .<span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 50051</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">CMD</span><span class="s"> [&#34;go&#34;, &#34;run&#34;, &#34;main.go&#34;, &#34;echo.pb.go&#34;]</span></code></pre></div>
<p>Dockerイメージをレジストリにプッシュします。コンソールでContainer Registry APIを有効にしておく必要があります。<a href="https://console.cloud.google.com/apis/api/containerregistry.googleapis.com/overview?project=cloud-endpoints-grpc-auth">https://console.cloud.google.com/apis/api/containerregistry.googleapis.com/overview?project=cloud-endpoints-grpc-auth</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> server
docker build -t gcr.io/cloud-endpoints-grpc-auth/echo .
gcloud docker -- push gcr.io/cloud-endpoints-grpc-auth/echo</code></pre></div>
<p>KubernetesのDeploymentとServiceの設定ファイルを作ります。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml:server/k8s.yaml" data-lang="yaml:server/k8s.yaml">apiVersion<span class="p">:</span><span class="w"> </span>extensions/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>echo<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>replicas<span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span>template<span class="p">:</span><span class="w">
</span><span class="w">    </span>metadata<span class="p">:</span><span class="w">
</span><span class="w">      </span>labels<span class="p">:</span><span class="w">
</span><span class="w">        </span>service<span class="p">:</span><span class="w"> </span>echo<span class="w">
</span><span class="w">    </span>spec<span class="p">:</span><span class="w">
</span><span class="w">      </span>containers<span class="p">:</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>esp<span class="w">
</span><span class="w">          </span>image<span class="p">:</span><span class="w"> </span>gcr.io/endpoints-release/endpoints-runtime<span class="p">:</span><span class="m">1</span><span class="w">
</span><span class="w">          </span>imagePullPolicy<span class="p">:</span><span class="w"> </span>Always<span class="w">
</span><span class="w">          </span>args<span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w">            </span><span class="s2">&#34;-P&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;9000&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="s2">&#34;-a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;grpc://127.0.0.1:50051&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="s2">&#34;-s&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="s2">&#34;-v&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;2018-02-05r0&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">          </span><span class="p">]</span><span class="w">
</span><span class="w">          </span>ports<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">        </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>echo<span class="w">
</span><span class="w">          </span>image<span class="p">:</span><span class="w"> </span>gcr.io/cloud-endpoints-grpc-auth/echo<span class="w">
</span><span class="w">          </span>ports<span class="p">:</span><span class="w">
</span><span class="w">            </span>-<span class="w"> </span>containerPort<span class="p">:</span><span class="w"> </span><span class="m">50051</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>echo<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>LoadBalancer<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span><span class="w">      </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>service<span class="p">:</span><span class="w"> </span>echo</code></pre></div>
<p>ESPの<code>args</code>の<code>-s</code>はサービス名、<code>-v</code>は設定IDです。Endpointをデプロイしたときに表示されたものを使います。</p>

<p>GKEクラスタを作成してAPIをデプロイします。Kubernetes Engine APIを有効にしておく必要があります。
<a href="https://console.cloud.google.com/apis/api/container.googleapis.com/overview?project=cloud-endpoints-grpc-auth">https://console.cloud.google.com/apis/api/container.googleapis.com/overview?project=cloud-endpoints-grpc-auth</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># GKEクラスタ作成</span>
gcloud container clusters create cluster-1 <span class="se">\
</span><span class="se"></span>  --cluster-version <span class="m">1</span>.8.7-gke.0 <span class="se">\
</span><span class="se"></span>  --num-nodes <span class="m">1</span> <span class="se">\
</span><span class="se"></span>  --zone asia-northeast1-a

<span class="c1"># APIデプロイ</span>
gcloud container clusters get-credentials cluster-1 --zone asia-northeast1-a
kubectl create -f k8s.yaml</code></pre></div>
<p>しばらくするとGCEのロードバランサが作成されてIPが取得できるので、クライアントでリクエストしてみます。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">ADDRESS</span><span class="o">=</span><span class="k">$(</span>kubectl get service <span class="nb">echo</span> --output <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.status.loadBalancer.ingress[0].ip}&#34;</span><span class="k">)</span>
<span class="nb">cd</span> client
go run *.go -addr<span class="o">=</span><span class="si">${</span><span class="nv">ADDRESS</span><span class="si">}</span>:80</code></pre></div>
<p>次のように出力されます。</p>

<pre><code>Echo1: succeeded: message:&quot;Hello&quot;
Echo2: failed: rpc error: code = Unauthenticated desc = JWT validation failed: Missing or invalid credentials
Echo3: failed: rpc error: code = Unauthenticated desc = Method doesn't allow unregistered callers (callers without established identity). Please use API Key or other form of API consumer identity to call this API.
Echo4: failed: rpc error: code = Unauthenticated desc = JWT validation failed: Missing or invalid credentials
</code></pre>

<p>なんの認証もかかっていないEcho1だけレスポンスを返します。他はESPで拒否されています。</p>

<p>ログを見るとESPで401を返していることがわかります。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl logs -lservice<span class="o">=</span><span class="nb">echo</span> -c esp
<span class="m">10</span>.52.0.1 - - <span class="o">[</span><span class="m">05</span>/Feb/2018:05:50:59 +0000<span class="o">]</span> <span class="s2">&#34;POST /echo.EchoService/Echo1 HTTP/2.0&#34;</span> <span class="m">200</span> <span class="m">12</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;grpc-go/1.10.0-dev&#34;</span>
<span class="m">2018</span>/02/05 <span class="m">05</span>:50:59 <span class="o">[</span>warn<span class="o">]</span> <span class="m">9</span><span class="c1">#9: *1 a client request body is buffered to a temporary file /var/cache/nginx/client_temp/0000000001, client: 10.52.0.1, server: , request: &#34;POST /echo.EchoService/Echo1 HTTP/2.0&#34;, host: &#34;35.189.159.64:80&#34;</span>
<span class="m">2018</span>/02/05 <span class="m">05</span>:50:59<span class="o">[</span>warn<span class="o">]</span><span class="m">9</span><span class="c1">#9: Received non-matching report response service config ID: &#39;&#39;, requested: &#39;2018-02-05r0&#39;</span>
<span class="m">10</span>.52.0.1 - - <span class="o">[</span><span class="m">05</span>/Feb/2018:05:50:59 +0000<span class="o">]</span> <span class="s2">&#34;POST /echo.EchoService/Echo2 HTTP/2.0&#34;</span> <span class="m">401</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;grpc-go/1.10.0-dev&#34;</span>
<span class="m">10</span>.52.0.1 - - <span class="o">[</span><span class="m">05</span>/Feb/2018:05:50:59 +0000<span class="o">]</span> <span class="s2">&#34;POST /echo.EchoService/Echo3 HTTP/2.0&#34;</span> <span class="m">401</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;grpc-go/1.10.0-dev&#34;</span>
<span class="m">10</span>.52.0.1 - - <span class="o">[</span><span class="m">05</span>/Feb/2018:05:50:59 +0000<span class="o">]</span> <span class="s2">&#34;POST /echo.EchoService/Echo4 HTTP/2.0&#34;</span> <span class="m">401</span> <span class="m">0</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;grpc-go/1.10.0-dev&#34;</span></code></pre></div>
<h2 id="apiキーで認証">APIキーで認証</h2>

<p>クライアントが認証できるようにしていきます。</p>

<p>まず、APIキーを取得します。コンソールのAPIとサービスの認証情報から、APIキーを作成します。
<a href="https://console.cloud.google.com/apis/credentials?project=cloud-endpoints-grpc-auth">https://console.cloud.google.com/apis/credentials?project=cloud-endpoints-grpc-auth</a></p>

<p>なんらかの制限をかけるように警告されるので、ここではHTTP リファラーを設定してみます。とりあえず<code>dummy.example.com</code>としておきます。</p>

<p>クライアントのコードを次のように修正します。</p>
<div class="highlight"><pre class="chroma"><code class="language-go:client/main.go" data-lang="go:client/main.go"><span class="c1">// 省略
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">credential</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">key</span>     <span class="kt">string</span>
	<span class="nx">referer</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">credential</span><span class="p">)</span> <span class="nf">GetRequestMetadata</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">uri</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;x-api-key&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
		<span class="s">&#34;referer&#34;</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">referer</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">credential</span><span class="p">)</span> <span class="nf">RequireTransportSecurity</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">referer</span> <span class="kt">string</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">addr</span><span class="p">,</span> <span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;127.0.0.1:50051&#34;</span><span class="p">,</span> <span class="s">&#34;server address&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">msg</span><span class="p">,</span> <span class="s">&#34;msg&#34;</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">,</span> <span class="s">&#34;message&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">key</span><span class="p">,</span> <span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;invalid&#34;</span><span class="p">,</span> <span class="s">&#34;API Key&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">referer</span><span class="p">,</span> <span class="s">&#34;referer&#34;</span><span class="p">,</span> <span class="s">&#34;invalid&#34;</span><span class="p">,</span> <span class="s">&#34;referer&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="nx">cred</span> <span class="o">:=</span> <span class="nx">credential</span><span class="p">{</span>
		<span class="nx">key</span><span class="p">:</span>     <span class="nx">key</span><span class="p">,</span>
		<span class="nx">referer</span><span class="p">:</span> <span class="nx">referer</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">(),</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithPerRPCCredentials</span><span class="p">(</span><span class="nx">cred</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

        <span class="c1">// 省略
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>認証情報をリクエストに付加する方法は何通りかありますが、grpcパッケージのAPIを見る限りこれがよさそうな気がします。</p>

<p>これを実行すると、次のようにAPIキーでの認証が成功していることがわかります。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ go run *.go -addr<span class="o">=</span><span class="si">${</span><span class="nv">ADDRESS</span><span class="si">}</span>:80 -key<span class="o">=</span><span class="si">${</span><span class="nv">API_KEY</span><span class="si">}</span> -referer<span class="o">=</span>dummy.example.com
Echo1: succeeded: message:<span class="s2">&#34;Hello&#34;</span>
Echo2: failed: rpc error: <span class="nv">code</span> <span class="o">=</span> Unauthenticated <span class="nv">desc</span> <span class="o">=</span> JWT validation failed: Missing or invalid credentials
Echo3: succeeded: message:<span class="s2">&#34;Hello&#34;</span>
Echo4: failed: rpc error: <span class="nv">code</span> <span class="o">=</span> Unauthenticated <span class="nv">desc</span> <span class="o">=</span> JWT validation failed: Missing or invalid credentials</code></pre></div>
<p>認証はESPが行うのでサーバのコードは変更不要です。</p>

<h2 id="サービスアカウントで認証">サービスアカウントで認証</h2>

<p>次にサービスアカウントで認証します。認証にはトークンが必要になるので、まずサービスアカウントの秘密鍵でJSON Web Tokenを生成します。</p>

<p>サービスアカウントの秘密鍵はJSONで生成して<code>client/service_account.json</code>に保存しておいてください。</p>

<p>JWT生成にはPythonスクリプトを使います。このスクリプトは<a href="https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/endpoints/bookstore-grpc/jwt_token_gen.py">Google公式のもの</a>を少し修正しています。公式のものだとIssuerとSubjectが異なるため認証できません。<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup></p>
<div class="highlight"><pre class="chroma"><code class="language-python:client/gen_jwt.py" data-lang="python:client/gen_jwt.py"><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">google.auth.crypt</span>
<span class="kn">import</span> <span class="nn">google.auth.jwt</span>

<span class="n">MAX_TOKEN_LIFETIME_SECS</span> <span class="o">=</span> <span class="mi">3600</span>

<span class="k">def</span> <span class="nf">generate_jwt</span><span class="p">(</span><span class="n">service_account_file</span><span class="p">,</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">audiences</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">service_account_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">service_account_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

    <span class="n">signer</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">crypt</span><span class="o">.</span><span class="n">RSASigner</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span>
        <span class="n">service_account_info</span><span class="p">[</span><span class="s1">&#39;private_key&#39;</span><span class="p">],</span>
        <span class="n">service_account_info</span><span class="p">[</span><span class="s1">&#39;private_key_id&#39;</span><span class="p">])</span>

    <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;iat&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
        <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="n">now</span> <span class="o">+</span> <span class="n">MAX_TOKEN_LIFETIME_SECS</span><span class="p">,</span>
        <span class="s1">&#39;aud&#39;</span><span class="p">:</span> <span class="n">audiences</span><span class="p">,</span>
        <span class="s1">&#39;iss&#39;</span><span class="p">:</span> <span class="n">issuer</span><span class="p">,</span>
        <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="n">issuer</span><span class="p">,</span>
        <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;user@example.com&#39;</span>
    <span class="p">}</span>

    <span class="n">signed_jwt</span> <span class="o">=</span> <span class="n">google</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">signer</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">signed_jwt</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--file&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The path to your service account json file.&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--issuer&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;issuer&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--audiences&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;audiences&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">signed_jwt</span> <span class="o">=</span> <span class="n">generate_jwt</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="nb">file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">issuer</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">audiences</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">signed_jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span></code></pre></div>
<p>実行します。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">JWT</span><span class="o">=</span><span class="k">$(</span>python gen_jwt.py --file service_account.json --audience echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog --issuer client1@cloud-endpoints-grpc-auth.iam.serviceaccount.com<span class="k">)</span></code></pre></div>
<p><code>audience</code>はCloud Endpointsのサービス名 (サービス設定の<code>name</code>)、<code>issuer</code>はサービス設定で設定した<code>issuer</code>と一致する必要があります。</p>

<p>クライアントを次のように修正します。</p>
<div class="highlight"><pre class="chroma"><code class="language-go:client/main.go" data-lang="go:client/main.go"><span class="c1">// 適当に省略
</span><span class="c1"></span>
<span class="kd">type</span> <span class="nx">credential</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">key</span>     <span class="kt">string</span>
	<span class="nx">referer</span> <span class="kt">string</span>
	<span class="nx">jwt</span>     <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">credential</span><span class="p">)</span> <span class="nf">GetRequestMetadata</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">uri</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;x-api-key&#34;</span><span class="p">:</span>     <span class="nx">c</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
		<span class="s">&#34;referer&#34;</span><span class="p">:</span>       <span class="nx">c</span><span class="p">.</span><span class="nx">referer</span><span class="p">,</span>
		<span class="s">&#34;authorization&#34;</span><span class="p">:</span> <span class="s">&#34;Bearer &#34;</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">jwt</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">referer</span><span class="p">,</span> <span class="nx">jwt</span> <span class="kt">string</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">jwt</span><span class="p">,</span> <span class="s">&#34;jwt&#34;</span><span class="p">,</span> <span class="s">&#34;invalid&#34;</span><span class="p">,</span> <span class="s">&#34;JSON Web Token&#34;</span><span class="p">)</span>

	<span class="nx">cred</span> <span class="o">:=</span> <span class="nx">credential</span><span class="p">{</span>
		<span class="nx">key</span><span class="p">:</span>     <span class="nx">key</span><span class="p">,</span>
		<span class="nx">referer</span><span class="p">:</span> <span class="nx">referer</span><span class="p">,</span>
		<span class="nx">jwt</span><span class="p">:</span>     <span class="nx">jwt</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>これを実行するとすべての認証が成功します。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">go run *.go -addr<span class="o">=</span><span class="si">${</span><span class="nv">ADDRESS</span><span class="si">}</span>:80 -key<span class="o">=</span><span class="si">${</span><span class="nv">API_KEY</span><span class="si">}</span> -referer<span class="o">=</span>dummy.example.com -jwt<span class="o">=</span><span class="si">${</span><span class="nv">JWT</span><span class="si">}</span>
Echo1: succeeded: message:<span class="s2">&#34;Hello&#34;</span>
Echo2: succeeded: message:<span class="s2">&#34;Hello&#34;</span>
Echo3: succeeded: message:<span class="s2">&#34;Hello&#34;</span>
Echo4: succeeded: message:<span class="s2">&#34;Hello&#34;</span></code></pre></div>
<p>サーバのログを見ると、それぞれの認証でMetadataがどうなっているか確認できます。JWTやAPIキーがそのまま格納されるようです。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">kubectl logs -lservice<span class="o">=</span><span class="nb">echo</span> -c echo</code></pre></div>
<h1 id="認証の組合せ">認証の組合せ</h1>

<p>確認するため雑な表にしてみました。</p>

<p><img width="994" alt="スクリーンショット 2018-02-05 16.15.16.png (270.9 kB)" src="/images/2018/02/05/1.png"></p>

<p>どちらも認証がかかっている場合は、どちらかが不正だとエラーになりました。また、両方不正な場合はサービスアカウント認証のエラーが返ってきました。</p>

<p>APIキー、JWTともにフォーマットが不正だとその旨のエラーが返ってきます。</p>

<p>APIキーの認証エラーは次のような感じで結構細かくメッセージが返ってきました。</p>

<pre><code># フォーマット不正
code = InvalidArgument desc = API key not valid. Please pass a valid API key.

# 違うプロジェクトのAPIキー
code = PermissionDenied desc = API echo.endpoints.cloud-endpoints-grpc-auth.cloud.goog is not enabled for the project.

# 削除した
code = InvalidArgument desc = API key expired. Please renew the API key.
</code></pre>

<h1 id="おわりに">おわりに</h1>

<p>サンプルがなかったりドキュメントが間違ってたりしますが、認証を自分で持たなくていいのはとても楽ですね。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="https://github.com/grpc/grpc/blob/master/src/core/lib/security/credentials/jwt/jwt_verifier.cc#L298-L306">https://github.com/grpc/grpc/blob/master/src/core/lib/security/credentials/jwt/jwt_verifier.cc#L298-L306</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

  </div>
</article>

      </div>
    </div>

    <div id="navigation-container">
      <div class="container">

<div id="footer-navigation">
  <div id="next-prev">
    <div><a href="https://blog.nownabe.com/2018/02/04/1246.html/">&lt; ふりかえり v2018.2</a></div>
    <div><a href="https://blog.nownabe.com/2018/02/06/1250.html/">Python機械学習プログラミング  第8章 &gt;</a></div>
  </div>
  <div id="related-articles"><h2>See Also</h2>
    <ul><li><a href="/2018/08/27/1385.html/">KubernetsのSecretのYAMLを暗号化したりするツールを作った</a></li><li><a href="/2018/08/22/1382.html/">GoのKubernetesオブジェクトをYAMLからDeserializeする</a></li><li><a href="/2018/02/25/1263.html/">PythonのgRPCサーバのテスト</a></li><li><a href="/2017/12/27/1232.html/">goenvを使うようにした</a></li><li><a href="/2017/12/25/1228.html/">GolangでNEologdでMeCab</a></li></ul></div>
  <div id="sns-buttons">
    <ul>
      <li>
        <div class="twitter-button">
          <a class="twitter-share-button" href="https://twitter.com/share" data-via="nownabe" data-related="nownabe">Tweet</a>
        </div>
      </li>
      <li>
        <div class="fb-like" data-layout="button_count" data-action="like" data-size="small" data-show-faces="false" data-share="true"></div>
      </li>
      <li>
        <a class="hatena-bookmark-button" href="http://b.hatena.ne.jp/entry/" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加">
          <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;">
        </a>
      </li>
      <li>
        <a class="pocket-btn" data-pocket-label="pocket" data-pocket-count="horizontal" data-lang="en"></a>
      </li>
    </ul>
  </div>
</div>

      </div>
    </div><div id="footer-container">
  <footer class="container">
    <p class="copyright">
      Copyright &copy; 2016
      <img src="/img/nownabe.svg" alt="now">
      nownabe All Right Reserved.
    </p>
  </footer>
  <aside id="information" class="container">
    <ul id="links">
      <li>
        <a href="https://nownabe.github.io/">
          <img src="/img/nownabe.svg" alt="nownabe.github.io">
        </a>
      </li>
      <li>
        <a href="https://github.com/nownabe">
          <img src="/img/github.svg" alt="GitHub">
        </a>
      </li>
      <li>
        <a href="https://qiita.com/nownabe">
          <img src="/img/qiita.svg" alt="Qiita">
        </a>
      </li>
      <li>
        <a href="https://twitter.com/nownabe">
          <img src="/img/twitter.svg" alt="Twitter">
        </a>
      </li>
      <li>
        <a href="https://www.facebook.com/nownabe">
          <img src="/img/facebook.png" alt="Facebook">
        </a>
      </li>
    </ul>
  </aside>
</div>
<div id="fb-root"></div>
  </div>
  <script>
    
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');

    
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=1775541316016693";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    
    !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");

  </script>
  <script src="https://b.st-hatena.com/js/bookmark_button.js" async="async"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      anchors.add(".body h1, .body h2, .body h3");
    });
  </script>
</body>
</html>
