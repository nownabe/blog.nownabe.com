box: ruby:2.6.0

deploy:
  steps:
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
    - script:
        name: configure git user
        code: |
          set -x
          git config --global user.name $WERCKER_STARTED_BY
          git config --global user.email `git log -1 --format="%ce"`
    - add-ssh-key:
        keyname: DEPLOY_SSH_KEY
        host: github.com
    - script:
        name: Git clone
        code: |
          set -x
          dir=$(pwd)
          cd ..
          rm -rf $dir
          mkdir -p $dir
          cd $dir
          git clone \
            --quiet \
            --progress \
            --no-single-branch \
            git@${WERCKER_GIT_DOMAIN}:${WERCKER_GIT_OWNER}/${WERCKER_GIT_REPOSITORY}.git ./
          git checkout -fq $WERCKER_GIT_COMMIT

    - script:
        name: Install build-essential
        code: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential libicu-dev cmake
    - script:
        name: Install Node.js
        code: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs
    - script:
        name: Clear bundle cache
        code: rm -rf /pipeline/cache/bundle-install/ruby/2.3.0/cache/bundler/git/*
    - bundle-install
    - script:
        name: deploy
        code: bundle exec middleman deploy --verbose

  after-steps:
    - slack-notifier:
        url: $SLACK_WEBHOOK_URL

