<!DOCTYPE html>
<html lang="ja"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><title>我が家の BigQuery による台所事情分析 - nownab.log</title><link rel="alternate" type="application/rss+xml" href="https://blog.nownabe.com/feed.xml" title="nownab.log">

  <link rel="icon" type="image/vnd.microsoft.icon" href="/favicon.ico">

  <link rel="stylesheet" href="/css/ress.min.css">
  <link rel="stylesheet" href="/css/chroma.css"><link rel="stylesheet" href="/css/main.min.13293a58c4075e6c78637f342d259e2618f348a845e353f1cf86ca0f1b6a91a0.css" integrity="sha256-Eyk6WMQHXmx4Y380LSWeJhjzSKhF41Pxz4bKDxtqkaA=">

  <meta name="author" content="nownabe">
  <meta name="description" content="the nownabe&#39;s life log">

  <meta property="og:site_name" content="nownab.log">
  <meta property="og:type" content="article">

  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:site" content="@nownabe">
  <meta property="twitter:creator" content="@nownabe">

  <meta property="fb:app_id" content="1775541316016693"><meta property="og:url" content="https://blog.nownabe.com/2020/12/13/home-finance-with-bigquery/">
  <meta property="og:title" content="我が家の BigQuery による台所事情分析 - nownab.log">
  <meta property="og:description" content="弊家では銀行やクレジットカードの明細を BigQuery に取り込んでダッシュボードを作ったりしています。 また、そのために作った BigQuery 向けの Go 製 ETL フレームワークを"><meta property="og:image" content="https://blog.nownabe.com/images/2020/12/13/og.png"><meta property="twitter:title" content="我が家の BigQuery による台所事情分析 - nownab.log">
  <meta property="twitter:description" content="弊家では銀行やクレジットカードの明細を BigQuery に取り込んでダッシュボードを作ったりしています。 また、そのために作った BigQuery 向けの Go 製 ETL フレームワークを">
  <meta property="twitter:image" content="https://blog.nownabe.com/images/2020/12/13/og.png">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PWWXNZ0XM3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PWWXNZ0XM3');
  </script></head>
<body>
  <div id="site-container"><div id="header-container">
  <header class="container">
    <h1>
      <a href="/">
        nownab.log
      </a>
    </h1>
  </header>
</div>
<div id="content-container">
      <div class="container" role="main">
<article class="article-container">
  <div class="title">
    <h2><a href="https://blog.nownabe.com/2020/12/13/home-finance-with-bigquery/">我が家の BigQuery による台所事情分析</a></h2>
    <span class="date">Posted on Dec 13, 2020</span>
  </div>
  <div class="article-columns">
    <div class="article-content">
      <div class="body">
        <p><a href="/images/2020/12/13/og.png"><img src="/images/2020/12/13/og.png" alt="dashboard"></a></p>
<p>弊家では銀行やクレジットカードの明細を BigQuery に取り込んでダッシュボードを作ったりしています。
また、そのために作った BigQuery 向けの Go 製 ETL フレームワークを OSS として公開しました。
本記事ではざっくりどんなもんかを紹介して、どう作るのかを説明します。</p>
<p><a href="https://qiita.com/advent-calendar/2020/gcp">Google Cloud Platform Advent Calendar 2020</a> の 13 日目の記事です。</p>
<p><a href="https://medium.com/google-cloud-jp/google-cloud-japan-customer-engineer-advent-calendar-2020-1c78e07e1871">Google Cloud Japan の Customer Engineer の Advent Calendar</a> もぜひご覧ください。</p>
<h2 id="tl-dr">TL; DR</h2>
<ul>
<li>明細が BigQuery にあると、可視化もできるしアラートも出せるし、まぁなんでもできて便利</li>
<li>銀行明細レベルのデータならほぼ無料で保存、ETL、分析できる</li>
<li>ETL フレームワーク <a href="https://github.com/nownabe/go-bqloader">bqloader</a> を OSS として公開したから使ってくれよな 💪</li>
</ul>
<p>説明しないこと:</p>
<ul>
<li>我が家の台所事情</li>
<li>BigQuery のクエリの書き方</li>
</ul>
<h2 id="対象読者">対象読者</h2>
<ul>
<li>GCP を触ったことがある人</li>
<li>お金まわりを分析したいと思っている人</li>
<li>身近な題材で BigQuery を触ってみたい人</li>
</ul>
<h2 id="ざっくり紹介">ざっくり紹介</h2>
<h3 id="何が嬉しいの">何が嬉しいの？</h3>
<p>BigQuery でできることができるようになります。
で終わらせるのもアレなので、弊家でのユースケースを列挙します。</p>
<ul>
<li>ダッシュボード
<ul>
<li>資産推移</li>
<li>出費分析</li>
<li>でかい出費ランキング</li>
</ul>
</li>
<li>アラート (銀行残高、クレジットカード)</li>
<li>予算管理</li>
</ul>
<p>例えばダッシュボードはこんな感じです。(記事用に加工してます)</p>
<p><a href="/images/2020/12/13/dashboard.png"><img src="/images/2020/12/13/dashboard.png" alt="dashboard"></a></p>
<p>BigQuery を使うことで、手動でやってたことを自動化できるようになったり、今までできなかったことができるようになったりしました。
SQL を書けばほしいデータをほしい形ですぐに手に入れることができて、それを簡単に様々なシステムと連携できるので超便利です。
おかげで自動化もできたし、良い感じのダッシュボードも作ることができて節約を頑張れそうです。</p>
<h3 id="money-forward-でええんちゃうの">Money Forward でええんちゃうの？</h3>
<p>いいです 😂</p>
<p>本記事の内容は劣化版 Money Forward の再実装と言える部分もあります。</p>
<p>Money Forward はとてもいいサービスなので弊家でも使っていますが、かゆいところに手が届かなかったり、使いたい機能が有料だったりしたので自分でも作りました。</p>
<p>自分で作ると手間はかかりますが Money Forward 以上のやりたいことがだいたい実現できるようになります。
BigQuery でクエリを書いて好きな結果を得られるというのは大きいですね。</p>
<h3 id="アーキテクチャ">アーキテクチャ</h3>
<p>こんな感じです。</p>
<p><a href="/images/2020/12/13/architecture.png"><img src="/images/2020/12/13/architecture.png" alt="architecture"></a></p>
<h3 id="課題">課題</h3>
<p>大きな課題が 2 点あります。</p>
<ul>
<li>CSV のダウンロード/アップロードが手動
<ul>
<li>銀行やクレジットカードの明細の CSV を手動でダウンロードしてアップロードしています<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
</ul>
</li>
<li>リアルタイム性がない
<ul>
<li>CSV を月イチで手動アップロードしてるので、リアルタイム性がありません</li>
</ul>
</li>
</ul>
<p>以前はスプレッドシートに手入力していた部分もあったので自分としては手間は減ってるし、できることは増えたし、お金はかかっていないしでハッピーなんですがめんどくささは残ります。
銀行が API 公開してくれたらいいんですけどね。</p>
<h3 id="無料なの">無料なの？</h3>
<p>無料ではないです。毎月 1 円請求が発生しています。
Cloud Functions のコンテナイメージを管理している Container Registry のバックエンドの Cloud Storage に料金がかかっています。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></p>
<p>下の画像は実際に弊家で使っているプロジェクトの Billing Report です。
(Subtotal は 4 ヶ月分が加算されて 4 円と表示されています)</p>
<p><a href="/images/2020/12/13/billing_report.png"><img src="/images/2020/12/13/billing_report.png" alt="billing report"></a></p>
<p>Cloud Storage や Cloud Functions や BigQuery は<a href="https://cloud.google.com/free">無料枠</a>におさまっています。
もし既に無料枠を使い切っている場合は料金が発生します。それぞれ以下のように無料枠があります。</p>
<ul>
<li>Cloud Storage: 5GB-月 (us-east1, us-west1, us-central1)</li>
<li>Cloud Functions: 200 万回/月</li>
<li>BigQuery: 1TB クエリ/月</li>
</ul>
<p>Cloud Storage の無料枠はリージョンが限定されています。
リージョンが異なると余計なネットワーク料金が発生したりするのでリージョンを揃えておくのもポイントです。
弊家ではすべてを使えるリージョンとして <code>us-east1</code> を選択しました。</p>
<p>銀行の明細は 1 ヶ月分でせいぜい数 KB、クエリもたかがしれてるのでなかなか無料枠を超えることはなさそうです。</p>
<h2 id="etl-フレームワーク-bqloader">ETL フレームワーク bqloader</h2>
<h3 id="bqloader-概要">bqloader 概要</h3>
<p><a href="https://github.com/nownabe/go-bqloader">bqloader</a>は Go 製のシンプルな ETL フレームワークです。
弊家の ETL をフレームワークとして切り出したものになります。
以下のような特徴があります。</p>
<ul>
<li>1 行を 1 行への変換に特化</li>
<li>ユーザは行単位の変換ロジックのみ実装</li>
<li>簡単な設定で文字コード変換、不要な行のスキップ、成功・失敗通知が可能</li>
<li>今のところ Cloud Storage、Cloud Functions、BigQuery 専用<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></li>
<li>1 つの Function で複数種のデータに対応</li>
</ul>
<p>Go で実装することになるので Go の知識はあった方がいいですが、なくても Hello, world ぐらいできればサンプル見ながら実装できるんじゃないでしょうか。</p>
<p>以下のような利点があります。</p>
<ul>
<li>ほぼ無料で使える</li>
<li>必要最低限の機能しかない</li>
<li>Go で書ける</li>
<li>複数種のデータの ETL を一箇所で管理できる</li>
</ul>
<h3 id="bqloader-使い方">bqloader 使い方</h3>
<p><a href="https://github.com/nownabe/go-bqloader/tree/main/examples/quickstart">サンプルプロジェクト</a>を見てもらうのがはやいです。
このサンプルの中で Service Account の作成や Function のデプロイ、BigQuery への ETL まで一通りカバーしています。</p>
<p>以下ではフレームワークのさわりだけ丁寧に説明していきます。
詳しくは<a href="https://pkg.go.dev/go.nownabe.dev/bqloader">godoc</a>やサンプルを見てください。</p>
<p>まず import します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;go.nownabe.dev/bqloader&#34;</span>
</code></pre></div><p>保存先テーブルごとに <code>bqloader.Handler</code> を設定します。
Cloud Storage にアップロードされたファイルが Handler の Pattern に一致する場合に処理されてテーブルにロードされます。
Handler を複数定義すればひとつの Pattern に複数の Handler を対応させることもできます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">handler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bqloader</span><span class="p">.</span><span class="nx">Handler</span><span class="p">{</span>
  <span class="nx">Name</span><span class="p">:</span>     <span class="s">&#34;main_bank&#34;</span><span class="p">,</span>          <span class="c1">// 通知などで使われる
</span><span class="c1"></span>  <span class="nx">Encoding</span><span class="p">:</span> <span class="nx">japanese</span><span class="p">.</span><span class="nx">ShiftJIS</span><span class="p">,</span>    <span class="c1">// 入力ファイルをShiftJISとして扱う
</span><span class="c1"></span>  <span class="nx">Parser</span><span class="p">:</span>   <span class="nx">bqloader</span><span class="p">.</span><span class="nf">CSVParser</span><span class="p">(),</span> <span class="c1">// 入力ファイルをCSVとして扱う
</span><span class="c1"></span>
  <span class="c1">// 先頭から1行を無視する (ヘッダのスキップ)
</span><span class="c1"></span>  <span class="nx">SkipLeadingRows</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

  <span class="c1">// この正規表現にマッチするパスのファイルを処理する
</span><span class="c1"></span>  <span class="nx">Pattern</span><span class="p">:</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">&#34;^main_bank/&#34;</span><span class="p">),</span>

  <span class="c1">// ロード先のBigQueryテーブル
</span><span class="c1"></span>  <span class="nx">Project</span><span class="p">:</span> <span class="s">&#34;my-project&#34;</span><span class="p">,</span>
  <span class="nx">Dataset</span><span class="p">:</span> <span class="s">&#34;my_dateset&#34;</span><span class="p">,</span>
  <span class="nx">Table</span><span class="p">:</span>   <span class="s">&#34;main_bank&#34;</span><span class="p">,</span>

  <span class="c1">// 後述
</span><span class="c1"></span>  <span class="nx">Notifier</span><span class="p">:</span>  <span class="nx">notifier</span><span class="p">,</span>
  <span class="nx">Projector</span><span class="p">:</span> <span class="nx">projector</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><p>変換のコアは<code>projector</code>です。<code>projector</code>は行単位の変換を実現する関数です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="cm">/*
</span><span class="cm">  例えば次のようなCSVの各行をBigQueryが理解できる形式に変換する。
</span><span class="cm">
</span><span class="cm">  日付,内容,出金金額,入金金額,残高
</span><span class="cm">  2020年12月13日,お賃金,0,&#34;180,000&#34;,&#34;200,000&#34;
</span><span class="cm">  
</span><span class="cm">  rowに1行が入る。上記の例だと次のようになる。
</span><span class="cm">  row == []string{&#34;2020年12月13日&#34;, &#34;お賃金&#34;, &#34;0&#34;, &#34;180,000&#34;, &#34;200,000&#34;}
</span><span class="cm">*/</span>
<span class="nx">projector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">row</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 日本語の日付から、BigQueryが解釈できる日付に変換する
</span><span class="c1"></span>  <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">&#34;2006年01月02日&#34;</span><span class="p">,</span> <span class="nx">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;time parse error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02&#34;</span><span class="p">)</span>

  <span class="c1">// 数値列のカンマを削除する
</span><span class="c1"></span>  <span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ReplaceAll</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
  <span class="nx">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ReplaceAll</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
  <span class="nx">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ReplaceAll</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">row</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p><code>notifier</code>は通知です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">notifier</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bqloader</span><span class="p">.</span><span class="nx">SlackNotifier</span><span class="p">{</span>
  <span class="nx">Token</span><span class="p">:</span>   <span class="s">&#34;xxxx&#34;</span><span class="p">,</span>
  <span class="nx">Channel</span><span class="p">:</span> <span class="s">&#34;#bqloader&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><p>この Handler を利用して Cloud Functions のエントリーポイントとなる関数を実装します。<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">MyFunc</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">e</span> <span class="nx">bqloader</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">loader</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">bqloader</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>

  <span class="c1">// 上述のmain_bank Handler
</span><span class="c1"></span>  <span class="nx">loader</span><span class="p">.</span><span class="nf">MustAddHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>

  <span class="c1">// 別のHandlerも登録できる
</span><span class="c1"></span>  <span class="nx">loader</span><span class="p">.</span><span class="nf">MustAddHandler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">creditCardHandler</span><span class="p">)</span>

  <span class="c1">// イベントを処理する
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Cloud Storage へのファイルアップロードなどのイベントで実行されます。<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>
<p>こんな感じで bqloader による関数を Cloud Functions にデプロイして、対応するバケットにファイルをアップロードすればデータが BigQuery にロードされます。</p>
<h2 id="bigquery-による台所事情分析の始め方">BigQuery による台所事情分析の始め方</h2>
<p>では銀行の明細を BigQuery にロードする ETL システムを構築してダッシュボードを作ってみましょう。</p>
<p>銀行の明細は<a href="https://docs.google.com/spreadsheets/d/1vTK8w2pA4Rrdi1fTBB9nq_dZ9VOIdGW35CdWQxzfWc4/edit?usp=sharing">このサンプル</a>を利用します。このデータを多くの銀行に倣って ShiftJIS の CSV として扱います。</p>
<p>前提として、Google Cloud のプロジェクトが必要になるので用意してください。
以下ではプロジェクト ID が <code>GCP_PROJECT</code> 環境変数にあるものとして説明します。
また、Go 環境と<a href="https://cloud.google.com/sdk/docs/install">Google Cloud SDK</a>はセットアップ済みとします。</p>
<p>作成するリソースはそれぞれ次の名前を使用します。</p>
<ul>
<li>Service Account: <code>bqloader</code></li>
<li>BigQuery Dataset: <code>bqloader_dataset</code></li>
<li>BigQuery Table: <code>main_bank</code></li>
<li>Cloud Storage Bucket: <code>gs://$GCP_PROJECT-source</code></li>
<li>Cloud Functions: <code>bqloader-func</code></li>
</ul>
<p>今回ダッシュボードには無料で簡単に使える Data Studio を使います。</p>
<h3 id="service-account-作成">Service Account 作成</h3>
<p>Cloud Functions 用の Service Account を作ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud iam service-accounts create bqloader --project <span class="nv">$GCP_PROJECT</span>
</code></pre></div><p>後で何回か使うので、Service Account の環境変数も設定しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">SERVICE_ACCOUNT</span><span class="o">=</span>bqloader@<span class="nv">$GCP_PROJECT</span>.iam.gserviceaccount.com
</code></pre></div><p>BigQuery の Job を実行する権限が必要になるので <code>roles/bigquery.jobUser</code> Role を付与します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud projects add-iam-policy-binding <span class="nv">$GCP_PROJECT</span> <span class="se">\
</span><span class="se"></span>  --member serviceAccount:<span class="nv">$SERVICE_ACCOUNT</span> <span class="se">\
</span><span class="se"></span>  --role roles/bigquery.jobUser
</code></pre></div><h3 id="bigquery-table-作成">BigQuery Table 作成</h3>
<p>スキーマの JSON を作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt;schema.json
</span><span class="s">[
</span><span class="s">  {
</span><span class="s">    &#34;name&#34;: &#34;date&#34;,
</span><span class="s">    &#34;type&#34;: &#34;DATE&#34;,
</span><span class="s">    &#34;mode&#34;: &#34;REQUIRED&#34;
</span><span class="s">  },
</span><span class="s">  {
</span><span class="s">    &#34;name&#34;: &#34;description&#34;,
</span><span class="s">    &#34;type&#34;: &#34;STRING&#34;,
</span><span class="s">    &#34;mode&#34;: &#34;NULLABLE&#34;
</span><span class="s">  },
</span><span class="s">  {
</span><span class="s">    &#34;name&#34;: &#34;withdrawal_amount&#34;,
</span><span class="s">    &#34;type&#34;: &#34;NUMERIC&#34;,
</span><span class="s">    &#34;mode&#34;: &#34;NULLABLE&#34;
</span><span class="s">  },
</span><span class="s">  {
</span><span class="s">    &#34;name&#34;: &#34;deposit_amount&#34;,
</span><span class="s">    &#34;type&#34;: &#34;NUMERIC&#34;,
</span><span class="s">    &#34;mode&#34;: &#34;NULLABLE&#34;
</span><span class="s">  },
</span><span class="s">  {
</span><span class="s">    &#34;name&#34;: &#34;balance&#34;,
</span><span class="s">    &#34;type&#34;: &#34;NUMERIC&#34;,
</span><span class="s">    &#34;mode&#34;: &#34;REQUIRED&#34;
</span><span class="s">  }
</span><span class="s">]
</span><span class="s">EOF</span>
</code></pre></div><p>BigQuery の Dataset と Table を作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Dataset作成</span>
bq --location us-east1 mk --dataset <span class="nv">$GCP_PROJECT</span>:bqloader_dataset

<span class="c1"># Table作成</span>
bq mk --table <span class="nv">$GCP_PROJECT</span>:bqloader_dataset.main_bank schema.json
</code></pre></div><p>先程作った Service Account に書き込み権限を付与します。<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">bq add-iam-policy-binding <span class="se">\
</span><span class="se"></span>  --member serviceAccount:<span class="nv">$SERVICE_ACCOUNT</span> <span class="se">\
</span><span class="se"></span>  --role roles/bigquery.dataEditor <span class="se">\
</span><span class="se"></span>  <span class="nv">$GCP_PROJECT</span>:bqloader_dataset.main_bank
</code></pre></div><h3 id="cloud-storage-bucket-作成">Cloud Storage Bucket 作成</h3>
<p>生データを保存する Bucket を作成します。
Cloud Functions のトリガーとなるイベントを発行するソースにもなります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gsutil mb -p <span class="nv">$GCP_PROJECT</span> -l US-EAST1 gs://<span class="nv">$GCP_PROJECT</span>-source
</code></pre></div><p>Service Account に読み込み権限を付与します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gsutil iam ch <span class="se">\
</span><span class="se"></span>  serviceAccount:<span class="si">${</span><span class="nv">SERVICE_ACCOUNT</span><span class="si">}</span>:roles/storage.objectViewer <span class="se">\
</span><span class="se"></span>  gs://<span class="nv">$GCP_PROJECT</span>-source
</code></pre></div><h3 id="cloud-functions-実装">Cloud Functions 実装</h3>
<p>まずは Handler を実装します。
今回は 1 つですが、Handler が増えたときにメンテしやすいように Handler ごとにファイルをわけておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// main_bank_handler.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">myfunc</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&#34;context&#34;</span>
        <span class="s">&#34;fmt&#34;</span>
        <span class="s">&#34;os&#34;</span>
        <span class="s">&#34;regexp&#34;</span>
        <span class="s">&#34;strings&#34;</span>
        <span class="s">&#34;time&#34;</span>

        <span class="s">&#34;golang.org/x/text/encoding/japanese&#34;</span>

        <span class="s">&#34;go.nownabe.dev/bqloader&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">cleanNumber</span><span class="p">(</span><span class="nx">n</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
        <span class="nx">n</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ReplaceAll</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="s">&#34;￥&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
        <span class="nx">n</span> <span class="p">=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ReplaceAll</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nx">n</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">mainBankHandler</span><span class="p">()</span> <span class="o">*</span><span class="nx">bqloader</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
        <span class="nx">projector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">&#34;2006年01月02日&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;time.Parse error: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02&#34;</span><span class="p">)</span>
                <span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nf">cleanNumber</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="nx">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">=</span> <span class="nf">cleanNumber</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="nx">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">=</span> <span class="nf">cleanNumber</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

                <span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">bqloader</span><span class="p">.</span><span class="nx">Handler</span><span class="p">{</span>
                <span class="nx">Name</span><span class="p">:</span>            <span class="s">&#34;main_bank&#34;</span><span class="p">,</span>
                <span class="nx">Pattern</span><span class="p">:</span>         <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">&#34;^main_bank/&#34;</span><span class="p">),</span>
                <span class="nx">Encoding</span><span class="p">:</span>        <span class="nx">japanese</span><span class="p">.</span><span class="nx">ShiftJIS</span><span class="p">,</span>
                <span class="nx">Parser</span><span class="p">:</span>          <span class="nx">bqloader</span><span class="p">.</span><span class="nf">CSVParser</span><span class="p">(),</span>
                <span class="nx">Projector</span><span class="p">:</span>       <span class="nx">projector</span><span class="p">,</span>
                <span class="nx">SkipLeadingRows</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>

                <span class="nx">Project</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;GCP_PROJECT&#34;</span><span class="p">),</span>
                <span class="nx">Dataset</span><span class="p">:</span> <span class="s">&#34;bqloader_dataset&#34;</span><span class="p">,</span>
                <span class="nx">Table</span><span class="p">:</span>   <span class="s">&#34;main_bank&#34;</span><span class="p">,</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>エントリーポイントとなる関数を実装します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// func.go
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">myfunc</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&#34;context&#34;</span>

        <span class="s">&#34;go.nownabe.dev/bqloader&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">loader</span> <span class="nx">bqloader</span><span class="p">.</span><span class="nx">BQLoader</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">loader</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">bqloader</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
        <span class="nx">loader</span><span class="p">.</span><span class="nf">MustAddHandler</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nf">mainBankHandler</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">MyFunc</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">e</span> <span class="nx">bqloader</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>Cloud Functions は Go Modules を理解してくれるので go.mod を作ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">go mod init
go mod tidy
</code></pre></div><h3 id="function-デプロイ">Function デプロイ</h3>
<p>必要な API を有効化します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud services <span class="nb">enable</span> <span class="se">\
</span><span class="se"></span>  --project <span class="nv">$GCP_PROJECT</span> <span class="se">\
</span><span class="se"></span>  cloudfunctions.googleapis.com <span class="se">\
</span><span class="se"></span>  cloudbuild.googleapis.com
</code></pre></div><p>デプロイします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">gcloud functions deploy bqloader-func <span class="se">\
</span><span class="se"></span>  --project <span class="nv">$GCP_PROJECT</span> <span class="se">\
</span><span class="se"></span>  --region us-east1 <span class="se">\
</span><span class="se"></span>  --runtime go113 <span class="se">\
</span><span class="se"></span>  --trigger-resource <span class="nv">$GCP_PROJECT</span>-source <span class="se">\
</span><span class="se"></span>  --trigger-event google.storage.object.finalize <span class="se">\
</span><span class="se"></span>  --entry-point MyFunc <span class="se">\
</span><span class="se"></span>  --service-account <span class="nv">$SERVICE_ACCOUNT</span> <span class="se">\
</span><span class="se"></span>  --set-env-vars <span class="s2">&#34;GCP_PROJECT=</span><span class="nv">$GCP_PROJECT</span><span class="s2">&#34;</span>
</code></pre></div><h3 id="csv-アップロード">CSV アップロード</h3>
<p>CSV ファイルをアップロードして、Cloud Functions にデプロイした bqloader を起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">curl https://blog.nownabe.com/files/2020/12/13/sample.csv <span class="se">\
</span><span class="se"></span>  <span class="p">|</span> gsutil cp - gs://<span class="nv">$GCP_PROJECT</span>-source/main_bank/sample.csv
</code></pre></div><h3 id="bigquery-確認">BigQuery 確認</h3>
<p>うまくいけば、ShiftJIS の銀行明細 CSV がいい感じに変換されて BigQuery にロードされています。
bq コマンドで確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">bq --project_id <span class="nv">$GCP_PROJECT</span> <span class="se">\
</span><span class="se"></span>  query --nouse_legacy_sql <span class="se">\
</span><span class="se"></span>  <span class="s2">&#34;SELECT * FROM </span><span class="nv">$GCP_PROJECT</span><span class="s2">.bqloader_dataset.main_bank LIMIT 5&#34;</span>
</code></pre></div><h3 id="ダッシュボード作成">ダッシュボード作成</h3>
<p>最後に<a href="https://datastudio.google.com/">Data Studio</a><sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>でダッシュボードを作成します。
が、Data Studio は操作が GUI で説明がめんどくさいのでフィーリングでやってみてください。
画面をポチポチやっていけば、なんとなく BigQuery の銀行明細データを読み込んでグラフが作れそうな雰囲気は感じてもらえると思います。</p>
<p>適当ですがこんな感じのダッシュボードを作れます。</p>
<p><a href="/images/2020/12/13/datastudio.png"><img src="/images/2020/12/13/datastudio.png" alt="data studio"></a></p>
<h2 id="おわりに">おわりに</h2>
<p>やってみると意外と簡単で楽しいのでぜひやってみてください。
弊家では今後もどんどんデータを増やして Data Driven な家庭を目指していきます。</p>
<p>あ、<a href="https://github.com/nownabe/go-bqloader">nownabe/go-bqloader</a> に Star くれると嬉しいです！⭐</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>アップロードはコマンド一発 <code>gsutil rsync</code> なので楽なんですが。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>コンテナイメージは Cloud Functions によって古いものは自動で削除されるので、何回デプロイしても 1 円で済むと予想しています。&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>Pull Request お待ちしています！&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>イベントについての詳細は<a href="https://cloud.google.com/functions/docs/calling/storage">Cloud Functions のドキュメント</a>を参照してください。&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p><code>bq add-iam-policy-binding</code> でエラーが出る場合は <code>gcloud components update</code> してみてください。&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>大人の事情で日本語だとデータポータルになってます。&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      </div>
    </div>
    <div class="article-toc-container">
      <aside class="article-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#tl-dr">TL; DR</a></li>
    <li><a href="#対象読者">対象読者</a></li>
    <li><a href="#ざっくり紹介">ざっくり紹介</a>
      <ul>
        <li><a href="#何が嬉しいの">何が嬉しいの？</a></li>
        <li><a href="#money-forward-でええんちゃうの">Money Forward でええんちゃうの？</a></li>
        <li><a href="#アーキテクチャ">アーキテクチャ</a></li>
        <li><a href="#課題">課題</a></li>
        <li><a href="#無料なの">無料なの？</a></li>
      </ul>
    </li>
    <li><a href="#etl-フレームワーク-bqloader">ETL フレームワーク bqloader</a>
      <ul>
        <li><a href="#bqloader-概要">bqloader 概要</a></li>
        <li><a href="#bqloader-使い方">bqloader 使い方</a></li>
      </ul>
    </li>
    <li><a href="#bigquery-による台所事情分析の始め方">BigQuery による台所事情分析の始め方</a>
      <ul>
        <li><a href="#service-account-作成">Service Account 作成</a></li>
        <li><a href="#bigquery-table-作成">BigQuery Table 作成</a></li>
        <li><a href="#cloud-storage-bucket-作成">Cloud Storage Bucket 作成</a></li>
        <li><a href="#cloud-functions-実装">Cloud Functions 実装</a></li>
        <li><a href="#function-デプロイ">Function デプロイ</a></li>
        <li><a href="#csv-アップロード">CSV アップロード</a></li>
        <li><a href="#bigquery-確認">BigQuery 確認</a></li>
        <li><a href="#ダッシュボード作成">ダッシュボード作成</a></li>
      </ul>
    </li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
      </aside>
    </div>
  </div>
</article>

      </div>
    </div>

    <div id="navigation-container">
      <div class="container">

<div id="footer-navigation">
  <div id="next-prev">
    <div><a href="https://blog.nownabe.com/2020/07/19/home-kubernetes-2/">&lt; おうちKubernetes構築日記その2 Kubernetes構築編</a></div>
    <div></div>
  </div>
  <div id="related-articles"></div>
  <div id="sns-buttons">
    <ul>
      <li>
        <div class="twitter-button">
          <a class="twitter-share-button" href="https://twitter.com/share" data-via="nownabe" data-related="nownabe">Tweet</a>
        </div>
      </li>
      <li>
        <div class="fb-like" data-layout="button_count" data-action="like" data-size="small" data-show-faces="false" data-share="true"></div>
      </li>
      <li>
        <a class="hatena-bookmark-button" href="http://b.hatena.ne.jp/entry/" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加">
          <img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;">
        </a>
      </li>
      <li>
        <a class="pocket-btn" data-pocket-label="pocket" data-pocket-count="horizontal" data-lang="en"></a>
      </li>
    </ul>
  </div>
</div>

      </div>
    </div><div id="container">
  <div id="footer-container">
    <div id="author">
      <p>
        <a href="https://nownabe.com">
          <img src="/img/profile_icon_2020.png" alt="profile icon">
        </a>
      </p>
      <div>
        <p class="name"><a href="https://nownabe.com">Shawn Watanabe</a></p>
        <p>
          A dog lover and a software engineer.
          I now work as a Customer Engineer at Google Cloud in Japan.
        </p>
        <p>
          Opinions are my own, NOT views of my employer.
        </p>
      </div>
    </div>
    <footer>
      <p class="copyright">
        Copyright &copy; 2016 nownabe All Right Reserved.
      </p>
    </footer>
  </div>
</div>
<div id="fb-root"></div>
  </div>
  <script>
    
    !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');

    
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.7&appId=1775541316016693";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    
    !function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");

  </script>
  <script src="https://b.st-hatena.com/js/bookmark_button.js" async="async"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      anchors.add(".body h1, .body h2, .body h3");
    });
  </script>
</body>
</html>
